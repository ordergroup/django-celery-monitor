{% extends "admin/base_site.html" %}
{% load static %}
{% load celery_monitor_tags %}

{% block extrahead %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/htmx.org@2.0.8/dist/htmx.min.js" 
        integrity="sha384-kBkPm+1FfKdJnqR1U8pAy5ZH1kjQZPXMy8DLQqmPvfZCU/wB7q8OLvDlG5yPfKKP" 
        crossorigin="anonymous"></script>
{% endblock %}

{% block title %}Celery Monitor Dashboard{% endblock %}

{% block extrastyle %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'celery_monitor/monitor.css' %}">
<script>
function toggleAccordion(id) {
  const element = document.getElementById(id);
  const icon = document.getElementById(id + '-icon');
  if (element.style.display === 'none') {
    element.style.display = 'block';
    icon.textContent = '▼';
  } else {
    element.style.display = 'none';
    icon.textContent = '▶';
  }
}
</script>
{% endblock %}

{% block content %}
{% has_celery_results as celery_results_installed %}
{% has_redis_broker as redis_available %}

<div>
  <h2 class="section-title">Workers</h2>
  <div hx-get="{% url 'admin:celery_monitor_worker_stats' %}" hx-trigger="load, every 5s" hx-swap="innerHTML"></div>
</div>

<div>
  <h2 class="section-title">Redis Queue Stats</h2>
  <div hx-get="{% url 'admin:celery_monitor_redis_queue_stats' %}" hx-trigger="load, every 5s" hx-swap="innerHTML"></div>
</div>

<div>
  <h2 class="section-title" style="cursor: pointer; user-select: none;" onclick="toggleAccordion('task-types-accordion')">
    <span id="task-types-accordion-icon">▶</span> Task Types per Queue
  </h2>
  <div id="task-types-accordion" style="display: none;" hx-get="{% url 'admin:celery_monitor_redis_queue_task_types' %}" hx-trigger="load, every 5s" hx-swap="innerHTML"></div>
</div>

<div>
  <h2 class="section-title">Overall Stats (django-celery-results)</h2>
  <div hx-get="{% url 'admin:celery_monitor_statuses_overall_count' %}" hx-trigger="load, every 5s" hx-swap="innerHTML"></div>
</div>

<div>
  <h2 class="section-title">Last Hour (django-celery-results)</h2>
  <div hx-get="{% url 'admin:celery_monitor_statuses_last_hour_count' %}" hx-trigger="load, every 5s" hx-swap="innerHTML"></div>
</div>


<div>
  <h2 class="section-title">Recent Tasks (last 50)</h2>
  <div hx-get="{% url 'admin:celery_monitor_recent_tasks' %}" hx-trigger="load" hx-swap="innerHTML"></div>
</div>
{% endblock %}
